{% extends "base.html" %}

{% block content %}
<div class="article-view-container fade-in">
    <!-- –•–µ–¥—ä—Ä –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞ -->
    <header class="article-header">
        <div class="d-flex align-items-center justify-content-center gap-2 mb-3">
            <span class="badge-category">{{ item.content_type }}</span>
            <span class="badge-topic">{{ item.category or '–û–±—â' }}</span>
        </div>
        <h1 class="article-title">{{ item.title }}</h1>
        <div class="article-meta">
            <span><i class="bi bi-person"></i> –æ—Ç GStroy Team</span>
            <span class="meta-divider">¬∑</span>
            <span><i class="bi bi-clock"></i> ~ {{ item.read_time_minutes or 2 }} –º–∏–Ω —á–µ—Ç–µ–Ω–µ</span>
        </div>
    </header>

    <!-- –ú—É–ª—Ç–∏–º–µ–¥–∏—è -->
    <div class="article-media">
        {% set media_src = item.media_url or '' %}
        {% if media_src %}
            {% if 'youtube.com' in media_src or 'youtu.be' in media_src %}
                <div class="ratio ratio-16x9">
                    <iframe src="{{ media_src | replace('watch?v=', 'embed/') }}" title="{{ item.title }}" allowfullscreen></iframe>
                </div>
            {% else %}
                <img src="{{ media_src if media_src.startswith('http') else url_for('static', filename=media_src) }}" alt="{{ item.title }}">
            {% endif %}
        {% else %}
            <div class="no-media-placeholder">
                <i class="bi bi-image"></i>
            </div>
        {% endif %}
    </div>

    <!-- –°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞ -->
    <article class="article-content">
        {{ item.content_html | safe }}
    </article>

    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
    <hr class="article-divider">

    <div class="article-actions">
        <button class="btn-mark-read mark-read-btn" data-item="{{ item.id }}">
            {% if progress and progress.is_read %}
                <i class="bi bi-check-circle-fill"></i> –ü—Ä–æ—á–µ—Ç–µ–Ω–æ
            {% else %}
                <i class="bi bi-check-circle"></i> –ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –ø—Ä–æ—á–µ—Ç–µ–Ω–æ
            {% endif %}
        </button>
        <div class="reactions-container">
            <span class="reactions-label">–ö–∞–∫ —Å–µ –ø–æ—á—É–≤—Å—Ç–≤–∞?</span>
            <div class="reactions-group">
                <button class="reaction-btn react-btn" data-reaction="like" data-item="{{ item.id }}" data-bs-toggle="tooltip" title="–•–∞—Ä–µ—Å–≤–∞ –º–∏!">üëç</button>
                <button class="reaction-btn react-btn" data-reaction="love" data-item="{{ item.id }}" data-bs-toggle="tooltip" title="–°—Ç—Ä–∞—Ö–æ—Ç–Ω–æ!">‚ù§Ô∏è</button>
                <button class="reaction-btn react-btn" data-reaction="fire" data-item="{{ item.id }}" data-bs-toggle="tooltip" title="–°—É–ø–µ—Ä –ø–æ–ª–µ–∑–Ω–æ!">üî•</button>
            </div>
        </div>
        <a href="#" class="btn-share" data-bs-toggle="tooltip" title="–°–ø–æ–¥–µ–ª–∏ (—Å–∫–æ—Ä–æ)">
            <i class="bi bi-share"></i>
        </a>
    </div>
</div>

<!-- –ú–æ–±–∏–ª–Ω–∞ –ª–µ–Ω—Ç–∞ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="mobile-action-bar d-lg-none">
    <a href="{{ url_for('academy.dashboard') }}" class="btn btn-sm btn-light border"><i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥</a>
    <button class="btn btn-sm btn-brand-new mark-read-btn" data-item="{{ item.id }}">
        {% if progress and progress.is_read %}–ü—Ä–æ—á–µ—Ç–µ–Ω–æ{% else %}–ú–∞—Ä–∫–∏—Ä–∞–π{% endif %}
    </button>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // –ê–∫—Ç–∏–≤–∏—Ä–∞–º–µ –≤—Å–∏—á–∫–∏ tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    document.body.addEventListener('click', function(event) {
        const target = event.target;
        
        // –ú–∞—Ä–∫–∏—Ä–∞–Ω–µ –∫–∞—Ç–æ –ø—Ä–æ—á–µ—Ç–µ–Ω–æ
        const markBtn = target.closest('.mark-read-btn');
        if (markBtn) {
            event.preventDefault();
            const allMarkButtons = document.querySelectorAll('.mark-read-btn[data-item="' + markBtn.dataset.item + '"]');
            
            fetch('{{ url_for('academy.mark_read', item_id=item.id) }}', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        allMarkButtons.forEach(btn => {
                            if(btn.classList.contains('btn-mark-read')) {
                                btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> –ü—Ä–æ—á–µ—Ç–µ–Ω–æ';
                            } else {
                                btn.textContent = '–ü—Ä–æ—á–µ—Ç–µ–Ω–æ';
                            }
                            btn.classList.add('read');
                        });
                    }
                });
        }

        // –†–µ–∞–∫—Ü–∏–∏
        const reactBtn = target.closest('.react-btn');
        if (reactBtn) {
            event.preventDefault();
            const reaction = reactBtn.dataset.reaction;
            
            // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ "active" –æ—Ç –≤—Å–∏—á–∫–∏ –±—É—Ç–æ–Ω–∏ –∑–∞ —Ä–µ–∞–∫—Ü–∏—è –∏ –≥–æ –¥–æ–±–∞–≤—è–º–µ –Ω–∞ –∫–ª–∏–∫–Ω–∞—Ç–∏—è
            document.querySelectorAll('.reaction-btn').forEach(btn => btn.classList.remove('active'));
            reactBtn.classList.add('active');

            fetch('{{ url_for('academy.react', item_id=item.id) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction }),
            });
        }
    });
});
</script>
{% endblock %}