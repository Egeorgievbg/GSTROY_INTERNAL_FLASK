{% extends "base.html" %}

{% block extra_styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}

{% block body_start %}
    <!-- –°–∫—Ä–æ–ª –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
    <div class="scroll-progress-container">
        <div class="scroll-progress-bar" id="readingProgress"></div>
    </div>
{% endblock %}

{% block content %}
<div class="article-view-wrapper fade-in">
    
    <!-- Hero Header -->
    <header class="hero-wrapper">
    <!-- 1. Background Image Layer -->
    <div class="hero-image-container">
        {% set media_src = item.media_url or '' %}
        {% if media_src %}
            <!-- –°–ª–∞–≥–∞–º–µ —Å–Ω–∏–º–∫–∞—Ç–∞ –∫–∞—Ç–æ background-image –∑–∞ –ø–æ-–ª–µ—Å–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–∞–Ω–µ -->
            <div class="hero-bg" style="background-image: url('{{ media_src if media_src.startswith('http') else url_for('static', filename=media_src) }}');"></div>
        {% else %}
            <div class="hero-bg placeholder-bg"></div>
        {% endif %}
        <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç, –∑–∞ –¥–∞ —Å–µ –≤–∏–∂–¥–∞ —Å—Ç—ä–∫–ª–æ—Ç–æ –ø–æ-–¥–æ–±—Ä–µ -->
        <div class="hero-overlay"></div>
    </div>

    <!-- 2. The Glass Card (Floating) -->
    <div class="container hero-content-container">
        <div class="glass-header-card fade-in-up">
            
            <!-- Category & Status Row -->
            <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                <span class="badge-category">
                    <i class="bi bi-folder2-open me-1"></i> {{ item.category|default('–û–±—É—á–µ–Ω–∏–µ')|upper }}
                </span>
                
                <!-- –¢—É–∫ –º–æ–∂–µ –¥–∞ –ø–æ–∫–∞–∂–µ–º —Å—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä. –∫–æ–ª–∫–æ —Ö–æ—Ä–∞ —Å–∞ –≥–æ —á–µ–ª–∏) -->
                <div class="social-proof">
                    <i class="bi bi-eye-fill text-muted me-1"></i>
                    <span class="small text-muted">–ü—Ä–µ–≥–ª–µ–¥–∞–Ω–æ –æ—Ç –µ–∫–∏–ø–∞</span>
                </div>
            </div>

            <!-- Main Title -->
            <h1 class="hero-title">{{ item.title }}</h1>

            <!-- Meta Data Grid -->
            <div class="meta-grid">
                <!-- Author -->
                <div class="meta-box">
                    <div class="meta-icon bg-blue">
                        <span class="initials">GS</span>
                    </div>
                    <div class="meta-info">
                        <span class="label">–ê–≤—Ç–æ—Ä</span>
                        <span class="value">GStroy Team</span>
                    </div>
                </div>

                <!-- Date -->
                <div class="meta-box">
                    <div class="meta-icon bg-green">
                        <i class="bi bi-calendar-event"></i>
                    </div>
                    <div class="meta-info">
                        <span class="label">–î–∞—Ç–∞</span>
                        <span class="value">{{ item.created_at.strftime('%d.%m.%Y') if item.created_at else '–°–µ–≥–∞' }}</span>
                    </div>
                </div>

                <!-- Time -->
                <div class="meta-box">
                    <div class="meta-icon bg-orange">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="meta-info">
                        <span class="label">–í—Ä–µ–º–µ</span>
                        <span class="value">~{{ item.read_time_minutes or 3 }} –º–∏–Ω.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

    <!-- Content Body (–°–≤–∏—Ç –∑–∞ –ø–æ-–¥–æ–±—Ä–æ —á–µ—Ç–µ–Ω–µ) -->
    <article class="article-content">
        {{ item.content_html | safe }}
    </article>

    <!-- Footer Space -->
    <div style="height: 120px;"></div>
</div>

<!-- FLOATING ACTION BAR (Fixed Bottom) -->
<div class="article-actions-bar">
    <div class="action-container glass-effect">
        <!-- Back Button -->
        <a href="{{ url_for('academy.dashboard') }}" class="action-btn icon-only" title="–ù–∞–∑–∞–¥ –∫—ä–º —Ç–∞–±–ª–æ—Ç–æ">
            <i class="bi bi-arrow-left"></i>
        </a>
        
        <div class="divider-vertical"></div>

        <!-- Reactions -->
        <div class="reactions-group">
            <button class="reaction-btn {% if progress and progress.reaction == 'like' %}active{% endif %}" onclick="sendReaction({{ item.id }}, 'like', this)">üëç</button>
            <button class="reaction-btn {% if progress and progress.reaction == 'love' %}active{% endif %}" onclick="sendReaction({{ item.id }}, 'love', this)">‚ù§Ô∏è</button>
            <button class="reaction-btn {% if progress and progress.reaction == 'fire' %}active{% endif %}" onclick="sendReaction({{ item.id }}, 'fire', this)">üî•</button>
        </div>

        <div class="divider-vertical"></div>

        <!-- Mark as Read Button -->
        <button id="markReadBtn" 
                class="action-btn mark-read {% if progress and progress.is_read %}read{% endif %}" 
                onclick="markAsRead({{ item.id }})">
            {% if progress and progress.is_read %}
                <i class="bi bi-check-circle-fill"></i> <span>–ü—Ä–æ—á–µ—Ç–µ–Ω–æ</span>
            {% else %}
                <i class="bi bi-check-circle"></i> <span>–ú–∞—Ä–∫–∏—Ä–∞–π</span>
            {% endif %}
        </button>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // 1. SCROLL PROGRESS
    window.addEventListener('scroll', () => {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        document.getElementById("readingProgress").style.width = scrolled + "%";
    });

    // 2. API LOGIC (–°–≤—ä—Ä–∑–≤–∞–Ω–µ —Å Python –±–µ–∫–µ–Ω–¥–∞)
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –º–∞—Ä–∫–∏—Ä–∞–Ω–µ –∫–∞—Ç–æ –ø—Ä–æ—á–µ—Ç–µ–Ω–æ
    async function markAsRead(itemId) {
        const btn = document.getElementById('markReadBtn');
        if (btn.classList.contains('read')) return; // –í–µ—á–µ –µ –ø—Ä–æ—á–µ—Ç–µ–Ω–æ

        // UI Optimistic Update (–í–µ–¥–Ω–∞–≥–∞ –ø–æ–∫–∞–∑–≤–∞–º–µ, —á–µ –µ —Å—Ç–∞–Ω–∞–ª–æ)
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        
        try {
            const response = await fetch(`/academy/api/mark-read/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (data.status === 'success') {
                btn.classList.add('read');
                btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span>–ü—Ä–æ—á–µ—Ç–µ–Ω–æ</span>';
                
                // –ö–æ–Ω—Ñ–µ—Ç–∏ –µ—Ñ–µ–∫—Ç (–ø–æ –∂–µ–ª–∞–Ω–∏–µ, –º–æ–∂–µ –¥–∞ —Å–µ –º–∞—Ö–Ω–µ)
                triggerConfetti(btn); 
            } else {
                btn.innerHTML = originalContent;
                alert('–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.');
            }
        } catch (error) {
            console.error('Error:', error);
            btn.innerHTML = originalContent;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞ —Ä–µ–∞–∫—Ü–∏–∏
    async function sendReaction(itemId, type, btnElement) {
        // –ú–∞—Ö–∞–º–µ –∞–∫—Ç–∏–≤–Ω–∏—è –∫–ª–∞—Å –æ—Ç –¥—Ä—É–≥–∏—Ç–µ
        document.querySelectorAll('.reaction-btn').forEach(b => b.classList.remove('active'));
        // –°–ª–∞–≥–∞–º–µ –Ω–∞ —Ç–µ–∫—É—â–∏—è
        btnElement.classList.add('active');
        
        // –õ–µ–∫–∞ –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞ –±—É—Ç–æ–Ω–∞
        btnElement.style.transform = "scale(1.4)";
        setTimeout(() => btnElement.style.transform = "scale(1)", 200);

        try {
            await fetch(`/academy/api/react/${itemId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction: type })
            });
            // –ù—è–º–∞ –Ω—É–∂–¥–∞ –¥–∞ —á–∞–∫–∞–º–µ –æ—Ç–≥–æ–≤–æ—Ä –∑–∞ UI-a, –Ω–µ–∫–∞ –µ "snappy"
        } catch (error) {
            console.error('Error reacting:', error);
        }
    }

    function triggerConfetti(element) {
        // –û–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ: –¢—É–∫ –º–æ–∂–µ –¥–∞ –¥–æ–±–∞–≤–∏—à JS –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞ –∫–æ–Ω—Ñ–µ—Ç–∏,
        // –Ω–æ –∑–∞—Å–µ–≥–∞ –ø—Ä–æ—Å—Ç–æ —â–µ –Ω–∞–ø—Ä–∞–≤–∏–º –ø—É–ª—Å–∞—Ü–∏—è
        element.style.animation = "pulse-green 0.5s ease-in-out";
    }

</script>
{% endblock %}