{% extends "base.html" %}

{% block title %}Pricemind Snapshots{% endblock %}

{% block extra_styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1400px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold mb-0">Pricemind Snapshots</h3>
    <a href="{{ url_for('admin.sync_center') }}" class="btn btn-sm btn-outline-secondary">Back to Sync Center</a>
  </div>

  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-md-4">
      <label class="form-label small text-muted mb-1">SKU</label>
      <input type="text" name="sku" class="form-control form-control-sm" value="{{ sku_query }}">
    </div>
    <div class="col-md-4">
      <label class="form-label small text-muted mb-1">Competitor</label>
      <input type="text" name="competitor" class="form-control form-control-sm" value="{{ competitor_query }}">
    </div>
    <div class="col-md-2">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" name="unmatched" value="1" id="unmatchedOnly" {% if unmatched_only %}checked{% endif %}>
        <label class="form-check-label small" for="unmatchedOnly">Unmatched only</label>
      </div>
    </div>
    <div class="col-md-2 text-md-end">
      <button class="btn btn-sm btn-dark w-100" type="submit">Filter</button>
    </div>
  </form>

  <div class="card border-0 shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>SKU</th>
            <th>Title</th>
            <th>My Price</th>
            <th>Lowest Price</th>
            <th>Lowest Competitor</th>
            <th>Matched</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for row in rows %}
              <tr>
                <td class="fw-bold">{{ row.sku }}</td>
                <td>{{ row.title or "-" }}</td>
                <td>{{ "%.2f"|format(row.my_price or 0) }}</td>
                <td>{{ "%.2f"|format(row.lowest_price or 0) }}</td>
                <td>{{ row.lowest_price_competitor or "-" }}</td>
                <td>
                  {% if row.product_id %}
                    <span class="badge bg-success">Yes</span>
                  {% else %}
                    <span class="badge bg-danger">No</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">No data found.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  {% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
  {% if total_pages > 1 %}
    <nav class="mt-3" aria-label="Pagination">
      <ul class="pagination pagination-sm">
        {% set prev_page = page - 1 %}
        {% set next_page = page + 1 %}
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin.pricemind_snapshots', sku=sku_query, competitor=competitor_query, unmatched=1 if unmatched_only else None, page=prev_page) }}">&laquo;</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">Page {{ page }} / {{ total_pages }}</span>
        </li>
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin.pricemind_snapshots', sku=sku_query, competitor=competitor_query, unmatched=1 if unmatched_only else None, page=next_page) }}">&raquo;</a>
        </li>
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
