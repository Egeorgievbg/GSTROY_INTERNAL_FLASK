{% extends "base.html" %}

{% block title %}Временни ограничения за достъп{% endblock %}

{% block extra_styles %}
<style>
    .access-card {
        border-radius: 16px;
        padding: 1.5rem;
        background: #fff;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
        border: 1px solid rgba(15, 23, 42, 0.08);
    }
    .access-window-row {
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        background: #f8fafc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1200px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="text-uppercase fw-bold text-muted" style="letter-spacing: 0.2em;">Админ</span>
            <h1 class="m-0">Ограничения за достъп</h1>
            <p class="text-muted small mb-0">Свържи роли, складове и служители с конкретни дни и часови прозорци.</p>
        </div>
        <a href="{{ url_for('admin.panel') }}" class="btn btn-outline-secondary">Назад в панела</a>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="access-card">
                <h5 class="fw-bold mb-3">Създай ново ограничение</h5>
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label small text-uppercase text-muted">Име на ограничението</label>
                        <input type="text" name="name" class="form-control" placeholder="Пример: Вечерни роли">
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-uppercase text-muted">Начален час</label>
                            <input type="time" name="start_time" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-uppercase text-muted">Краен час</label>
                            <input type="time" name="end_time" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-uppercase text-muted">Роли</label>
                        <select name="roles" class="form-select" multiple size="4">
                            {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small text-muted">Задръж Ctrl/Cmd за множествен избор.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-uppercase text-muted">Складове</label>
                        <select name="warehouses" class="form-select" multiple size="4">
                            {% for wh in warehouses %}
                                <option value="{{ wh.id }}">{{ wh.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-uppercase text-muted">Служители</label>
                        <select name="users" class="form-select" multiple size="4">
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-uppercase text-muted">Дни</label>
                        <div class="d-flex flex-wrap gap-2">
                            {% for day in days %}
                            <label class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="days" value="{{ day }}">
                                <span class="form-check-label small">{{ day }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <button class="btn btn-brand-new w-100">Създай ограничение</button>
                </form>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="fw-bold mb-1">Списък с ограничения</h5>
                    <p class="text-muted small mb-0">{{ windows|length }} записи</p>
                </div>
                <span class="badge bg-success bg-opacity-10 text-success">Актуални</span>
            </div>
            {% for window in windows %}
            <div class="access-window-row">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="fw-bold mb-1">{{ window.name }}</h6>
                        <div class="small text-muted">
                            {{ window.start_time.strftime('%H:%M') }} – {{ window.end_time.strftime('%H:%M') }} |
                            {{ window.days_list | join(', ') or '–' }}
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('admin.access_window_detail', window_id=window.id) }}" class="btn btn-sm btn-outline-primary">Редактирай</a>
                        <form method="post" action="{{ url_for('admin.delete_access_window', window_id=window.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Изтрий</button>
                        </form>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-sm-6">
                            <small class="text-uppercase text-muted">Роли</small>
                            <div class="text-dark small">
                                {{ window.roles|map(attribute='name')|join(', ') or '–' }}
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-uppercase text-muted">Складове</small>
                            <div class="text-dark small">
                                {{ window.warehouses|map(attribute='name')|join(', ') or '–' }}
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-uppercase text-muted">Служители</small>
                        <div class="text-dark small">
                            {{ window.users|map(attribute='full_name')|join(', ') or '–' }}
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-muted">Все още няма дефинирани ограничения.</div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
