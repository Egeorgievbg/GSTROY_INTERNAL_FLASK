{% extends "base.html" %}

{% block title %}{{ meta_title|default(category.name) }} | GSTROY AERO{% endblock %}

{% block content %}

<!-- РЎРўРР›РћР’Р• (РџСЂРµРјРµСЃС‚РµРЅРё С‚СѓРє, Р·Р° РґР° СЃРјРµ СЃРёРіСѓСЂРЅРё, С‡Рµ СЃРµ Р·Р°СЂРµР¶РґР°С‚) -->
<style>
    /* --- AERO CORE STYLES --- */
    :root {
        --brand-green: #a6cf39;
        --brand-dark: #0f172a;
        --brand-gray: #64748b;
        --shadow-card: 0 10px 30px -5px rgba(166, 207, 57, 0.15);
    }

    /* HERO SECTION */
    .cat-hero {
        background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(248,250,252,0.5) 100%);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 2rem 0;
        margin-bottom: 2rem;
    }

    /* SUBCATEGORY CHIPS (TREND 2025) */
    .chip-scroll-wrapper {
        position: relative;
    }
    .chip-scroll-container {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 5px 2px 10px 2px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Hide scrollbar Firefox */
    }
    .chip-scroll-container::-webkit-scrollbar { display: none; } /* Hide Chrome */
    
    .subcat-chip {
        white-space: nowrap;
        padding: 0.5rem 1rem;
        border-radius: 50rem;
        background: #fff;
        border: 1px solid #e2e8f0;
        color: var(--brand-dark);
        font-weight: 600;
        font-size: 0.85rem;
        display: flex; align-items: center; gap: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        text-decoration: none !important;
    }
    .subcat-chip:hover {
        transform: translateY(-2px);
        border-color: var(--brand-green);
        color: #166534; /* Dark Green Text */
        background-color: #f0fdf4;
        box-shadow: 0 5px 15px rgba(166, 207, 57, 0.15);
    }
    .subcat-chip i { font-size: 1rem; color: #94a3b8; transition: color 0.2s; }
    .subcat-chip:hover i { color: var(--brand-green); }

    /* SIDEBAR (Sticky & Glass) */
    .filter-sidebar {
        background: #fff; 
        border-radius: 16px; 
        padding: 1.5rem;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 4px 20px rgba(0,0,0,0.02);
    }
    
    /* Sticky behavior for sidebar on desktop */
    @media (min-width: 992px) {
        .filter-sidebar {
            position: sticky; 
            top: 100px;
            max-height: calc(100vh - 120px); 
            overflow-y: auto;
        }
    }

    /* PRODUCT CARD */
    .prod-card {
        background: #fff; border-radius: 16px; overflow: hidden;
        border: 1px solid rgba(0,0,0,0.04);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex; flex-direction: column; height: 100%;
        position: relative;
    }
    .prod-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-card); border-color: rgba(166, 207, 57, 0.3); }
    .prod-img-box { height: 200px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; padding: 1rem; }
    .prod-img { max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.5s; }
    .prod-card:hover .prod-img { transform: scale(1.08); }
    
    .prod-body { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
    .prod-title { font-size: 0.95rem; font-weight: 700; color: var(--brand-dark); line-height: 1.4; margin: 0.5rem 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .price-val { font-size: 1.2rem; font-weight: 800; color: var(--brand-dark); }
    
    .btn-brand-new {
        background: linear-gradient(135deg, #a6cf39 0%, #7ca323 100%); color: #fff; border: none;
        border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(166, 207, 57, 0.4); transition: all 0.2s;
    }
    .btn-brand-new:hover { transform: scale(1.1); box-shadow: 0 8px 20px rgba(166, 207, 57, 0.6); }

    /* Custom Scrollbar for sidebar */
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }

    /* CATEGORY NAV LINKS */
    .nav-link-cat {
        display: block; padding: 6px 10px; font-size: 0.9rem; color: #475569;
        text-decoration: none; border-radius: 6px; transition: all 0.2s;
    }
    .nav-link-cat:hover { background: #f1f5f9; color: var(--brand-dark); }
    .nav-link-cat.active { background: #dcfce7; color: #166534; font-weight: 700; }
    .nav-link-cat.active i { color: #166534; }
</style>

<!-- MACRO: RECURSIVE CATEGORY TREE -->
{% macro render_category_tree(categories, active_slug, level=0) %}
    <ul class="list-unstyled mb-0 ps-0">
        {% for cat in categories %}
            <li class="mb-1">
                <div class="d-flex align-items-center justify-content-between">
                    <a href="{{ url_for('category_page', slug=cat.slug) }}" 
                       class="nav-link-cat w-100 {{ 'active' if cat.slug == active_slug else '' }}"
                       style="padding-left: {{ (level * 12) + 10 }}px;">
                       {{ cat.name }}
                    </a>
                    
                    {% if cat.children %}
                        <button class="btn btn-sm p-0 text-muted border-0 me-2" type="button" data-bs-toggle="collapse" data-bs-target="#c-{{ cat.id }}">
                            <i class="bi bi-chevron-down" style="font-size: 0.75rem;"></i>
                        </button>
                    {% endif %}
                </div>
                
                {% if cat.children %}
                    <!-- Auto-expand if active category is inside -->
                    <div class="collapse {% if cat.slug == active_slug or (active_category_slug and cat.children|selectattr('slug', 'equalto', active_category_slug)|list) %}show{% endif %}" id="c-{{ cat.id }}">
                        {{ render_category_tree(cat.children, active_slug, level + 1) }}
                    </div>
                {% endif %}
            </li>
        {% endfor %}
    </ul>
{% endmacro %}


<!-- HERO HEADER -->
<div class="cat-hero">
    <div class="container-fluid px-4 px-lg-5">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb small text-uppercase fw-bold mb-0" style="font-size: 0.7rem;">
                <li class="breadcrumb-item"><a href="/" class="text-muted text-decoration-none">РќР°С‡Р°Р»Рѕ</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('products.products') }}" class="text-muted text-decoration-none">РљР°С‚Р°Р»РѕРі</a></li>
                {% for crumb in breadcrumb %}
                    {% if not loop.last %}
                        <li class="breadcrumb-item"><a href="{{ url_for('category_page', slug=crumb.slug) }}" class="text-muted text-decoration-none">{{ crumb.name }}</a></li>
                    {% else %}
                        <li class="breadcrumb-item active text-success">{{ crumb.name }}</li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>

        <div class="d-flex flex-wrap align-items-end justify-content-between gap-3">
            <div>
                <h1 class="fw-bolder mb-1 text-dark" style="font-size: 2rem; letter-spacing: -0.5px;">
                    {{ category.name }}
                </h1>
                <p class="text-muted mb-0 small" style="max-width: 600px;">
                    {{ category.description if category.description else category.name }}
                </p>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                 <span class="badge bg-white text-dark border rounded-pill px-3 py-2 shadow-sm">
                    <span class="fw-bold">{{ total_items }}</span> РџСЂРѕРґСѓРєС‚Р°
                 </span>
            </div>
        </div>

        <!-- SUBCATEGORY CHIPS (HORIZONTAL SCROLL) -->
        {% if subcategories %}
        <div class="mt-4 pt-3 border-top">
            <label class="small text-muted fw-bold text-uppercase mb-2 d-block" style="font-size: 0.7rem;">РџРѕРґРєР°С‚РµРіРѕСЂРёРё</label>
            <div class="chip-scroll-wrapper">
                <div class="chip-scroll-container">
                    {% for sub in subcategories %}
                    <a href="{{ url_for('category_page', slug=sub.slug) }}" class="subcat-chip">
                        <i class="bi bi-grid-fill"></i>
                        {{ sub.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- FLOATING MOBILE FILTER BTN -->
<div class="d-lg-none position-fixed start-50 translate-middle-x z-3" style="bottom: 30px; width: 90%; max-width: 400px;">
    <button class="btn btn-brand-new w-100 shadow-lg py-3 rounded-pill d-flex align-items-center justify-content-center gap-2 fw-bold text-uppercase" 
            type="button" data-bs-toggle="offcanvas" data-bs-target="#filterCanvas" 
            style="background: #0f172a; border-radius: 50rem;">
        <i class="bi bi-sliders2"></i> Р¤РёР»С‚СЂРёСЂР°Р№
    </button>
</div>


<div class="container-fluid px-4 px-lg-5 pb-5">
    
    <!-- BOOTSTRAP GRID LAYOUT (THE FIX) -->
    <div class="row g-4">
        
        <!-- SIDEBAR (DESKTOP ONLY) - COL-3 -->
        <div class="col-lg-3 d-none d-lg-block">
            <aside class="filter-sidebar">
                <div class="d-flex align-items-center justify-content-between mb-3 border-bottom pb-2">
                    <span class="fw-bold text-uppercase small text-muted">Р¤РёР»С‚СЂРё</span>
                    <a href="{{ url_for('category_page', slug=category.slug) }}" class="text-danger small fw-bold text-decoration-none">РР·С‡РёСЃС‚Рё</a>
                </div>

                <form action="" method="get">
                    <!-- Navigation -->
                    <div class="mb-4">
                        <h6 class="fw-bold small text-dark mb-2">РќР°РІРёРіР°С†РёСЏ</h6>
                        {{ render_category_tree(nav_categories, active_category_slug) }}
                    </div>

                    <!-- Price -->
                    <div class="mb-4">
                        <h6 class="fw-bold small text-dark mb-2">Р¦РµРЅР° (Р»РІ.)</h6>
                        <div class="d-flex gap-2">
                            <input type="number" class="form-control form-control-sm bg-light border-0 rounded-3" name="min_price" placeholder="РћС‚">
                            <input type="number" class="form-control form-control-sm bg-light border-0 rounded-3" name="max_price" placeholder="Р”Рѕ">
                        </div>
                    </div>

                    <!-- Brands -->
                    <div class="mb-4">
                        <h6 class="fw-bold small text-dark mb-2">РњР°СЂРєР°</h6>
                        <div style="max-height: 250px; overflow-y: auto;" class="pe-2 custom-scroll">
                            {% for brand in brands %}
                            <label class="d-flex align-items-center gap-2 mb-2 cursor-pointer">
                                <input type="radio" class="form-check-input mt-0" name="brand" value="{{ brand }}" {% if selected_brand == brand %}checked{% endif %}>
                                <span class="small text-muted fw-medium">{{ brand }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Hidden Params -->
                    <input type="hidden" name="sort" value="{{ sort }}">
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    
                    <button class="btn btn-dark w-100 rounded-pill fw-bold shadow-sm mt-2">РџСЂРёР»РѕР¶Рё</button>
                </form>
            </aside>
        </div>

        <!-- MAIN CONTENT - COL-9 -->
        <div class="col-lg-9">
            <main>
                <!-- Toolbar -->
                <div class="d-flex align-items-center justify-content-between mb-4 bg-white p-3 rounded-4 border shadow-sm">
                    <span class="text-muted small fw-bold">
                        {{ total_items }} Р РµР·СѓР»С‚Р°С‚Р°
                    </span>

                    <div class="d-flex align-items-center gap-3">
                        <!-- Sort -->
                        <div class="d-none d-md-block">
                            <select class="form-select border-0 bg-light rounded-pill text-muted small fw-bold ps-3 pe-5 py-2" 
                                    onchange="updateQueryParam('sort', this.value)">
                                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>РќР°Р№-РЅРѕРІРё</option>
                                <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Р¦РµРЅР° (РќРёСЃРєР° &rarr; Р’РёСЃРѕРєР°)</option>
                                <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Р¦РµРЅР° (Р’РёСЃРѕРєР° &rarr; РќРёСЃРєР°)</option>
                            </select>
                        </div>

                        <!-- View Switch -->
                        <div class="bg-light p-1 rounded-pill d-flex border">
                            <a href="{{ cards_url }}" class="btn btn-sm rounded-circle d-flex align-items-center justify-content-center {{ 'bg-white shadow-sm text-success' if view_mode == 'cards' else 'text-muted' }}" style="width: 32px; height: 32px;">
                                <i class="bi bi-grid-fill"></i>
                            </a>
                            <a href="{{ table_url }}" class="btn btn-sm rounded-circle d-flex align-items-center justify-content-center {{ 'bg-white shadow-sm text-success' if view_mode == 'table' else 'text-muted' }}" style="width: 32px; height: 32px;">
                                <i class="bi bi-list-ul"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Products -->
                <div id="products-wrapper" style="min-height: 50vh;">
                {% if products %}
                    {% if view_mode == 'cards' %}
                        <div class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 row-cols-xxl-4 g-4">
                            {% include "products_partial.html" %}
                        </div>
                    {% else %}
                        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0 table-clean">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4 py-3 small fw-bold text-muted text-uppercase">РџСЂРѕРґСѓРєС‚</th>
                                            <th class="py-3 small fw-bold text-muted text-uppercase">РРЅС„Рѕ</th>
                                            <th class="py-3 small fw-bold text-muted text-uppercase">Р›РѕРєР°С†РёСЏ</th>
                                            <th class="text-end pe-4 py-3 small fw-bold text-muted text-uppercase">Р¦РµРЅР°</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        {% include "products_partial.html" %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
                            <i class="bi bi-box-seam fs-1 text-muted"></i>
                        </div>
                        <h4>РќСЏРјР° РїСЂРѕРґСѓРєС‚Рё</h4>
                        <p class="text-muted">РџСЂРѕРјРµРЅРµС‚Рµ С„РёР»С‚СЂРёС‚Рµ Рё РѕРїРёС‚Р°Р№С‚Рµ РѕС‚РЅРѕРІРѕ.</p>
                        <a href="{{ url_for('category_page', slug=category.slug) }}" class="btn btn-outline-dark rounded-pill">РР·С‡РёСЃС‚Рё</a>
                    </div>
                {% endif %}
                </div>

                <!-- Load More -->
                {% if has_more %}
                <div class="text-center mt-5 mb-5">
                     <button id="btn-load-more" class="btn btn-white border shadow-sm rounded-pill px-5 py-3 text-dark fw-bold" data-next-page="{{ next_page }}">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        <span class="btn-text">Р—Р°СЂРµРґРё РѕС‰Рµ</span> <i class="bi bi-arrow-clockwise ms-1"></i>
                    </button>
                </div>
                {% endif %}
            </main>
        </div>
    </div>
</div>

<!-- OFFCANVAS MOBILE -->
<div class="offcanvas offcanvas-bottom h-auto" style="max-height: 85vh;" tabindex="-1" id="filterCanvas">
    <div class="offcanvas-header border-bottom bg-white sticky-top">
        <h5 class="offcanvas-title fw-bold">Р¤РёР»С‚СЂРё</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-4 custom-scrollbar">
        <form action="" method="get">
            
            <div class="mb-4">
                <label class="small fw-bold text-muted text-uppercase mb-2">РЎРѕСЂС‚РёСЂР°РЅРµ</label>
                <select class="form-select form-select-lg bg-light border-0" name="sort">
                    <option value="newest" {% if sort == 'newest' %}selected{% endif %}>РќР°Р№-РЅРѕРІРё</option>
                    <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Р¦РµРЅР° (Р’СЉР·С…РѕРґСЏС‰Р°)</option>
                    <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Р¦РµРЅР° (РќРёР·С…РѕРґСЏС‰Р°)</option>
                </select>
            </div>

            <div class="mb-4">
                 <label class="small fw-bold text-muted text-uppercase mb-2">РќР°РІРёРіР°С†РёСЏ</label>
                 <div class="border rounded-3 p-3">
                     {{ render_category_tree(nav_categories, active_category_slug) }}
                 </div>
            </div>

            <div class="mb-4">
                <label class="small fw-bold text-muted text-uppercase mb-2">РњР°СЂРєР°</label>
                <select class="form-select form-select-lg bg-light border-0" name="brand">
                    <option value="">Р’СЃРёС‡РєРё</option>
                    {% for brand in brands %}
                        <option value="{{ brand }}" {% if selected_brand == brand %}selected{% endif %}>{{ brand }}</option>
                    {% endfor %}
                </select>
            </div>

            <input type="hidden" name="view" value="{{ view_mode }}">
            
            <div class="d-grid gap-2 mt-5">
                <button class="btn btn-dark py-3 fw-bold rounded-pill">РџРѕРєР°Р¶Рё СЂРµР·СѓР»С‚Р°С‚Рё</button>
            </div>
        </form>
    </div>
</div>

<script>
    function updateQueryParam(key, value) {
        let url = new URL(window.location.href);
        url.searchParams.set(key, value);
        window.location.href = url.toString();
    }
</script>

{% endblock %}

{% block scripts %}
    {% include "_load_more_script.html" %}
{% endblock %}