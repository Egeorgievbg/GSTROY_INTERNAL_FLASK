{% extends "base.html" %}
{% block title %}Приход {{ invoice.invoice_number or invoice.id }} | GSTROY{% endblock %}

{% block content %}

<style>
    :root {
        --gs-primary: #9BCF53;
        --gs-dark: #1e293b;
        --card-radius: 12px;
    }

    .gs-card {
        border: none;
        border-radius: var(--card-radius);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03);
        background: #fff;
    }

    .detail-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #94a3b8;
        margin-bottom: 4px;
        font-weight: 600;
    }

    .detail-value {
        font-weight: 600;
        color: var(--gs-dark);
        font-size: 0.95rem;
    }

    .price-tag {
        font-family: 'Roboto Mono', monospace; /* or system monospace */
        font-weight: 500;
    }

    /* Table specifics */
    .table-details thead th {
        background-color: #f8fafc;
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #64748b;
        padding: 12px 16px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .table-details tbody td {
        padding: 16px;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
    }

    .product-match-card {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .diff-positive { color: #ef4444; font-weight: 700; } /* По-скъпо от очакваното */
    .diff-negative { color: #16a34a; font-weight: 700; } /* По-евтино */
    .diff-neutral { color: #94a3b8; }
    
    .status-dot {
        height: 10px;
        width: 10px;
        background-color: #cbd5e1;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }
    .status-dot.active { background-color: var(--gs-primary); box-shadow: 0 0 0 3px rgba(155, 207, 83, 0.2); }
</style>

<div class="container-fluid px-4 py-4">
    
    <!-- Top Navigation & Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
        <div class="d-flex align-items-center gap-3">
            <a href="{{ url_for('deliveries.deliveries_index') }}" class="btn btn-light rounded-circle shadow-sm" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <div class="d-flex align-items-center gap-2">
                    <h1 class="h4 fw-bold text-dark mb-0">Приход {{ invoice.invoice_number or 'Без номер' }}</h1>

            <!-- OCR Pages Log -->
            <div class="container-fluid px-4 py-2">
                <div class="gs-card p-4 mb-4">
                    <h5 class="fw-bold">OCR Статус по страници</h5>
                    <div class="mt-3">
                        {% if ocr_pages_log %}
                            <ul class="list-group">
                                {% for entry in ocr_pages_log %}
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-bold">Страница {{ entry.page }}</div>
                                            <div class="small text-muted">{{ entry.timestamp }}</div>
                                            {% if entry.status == 'ok' %}
                                                <div class="small mt-1">Разпознати редове: {{ entry.line_items_count or 0 }}</div>
                                            {% else %}
                                                <div class="small text-danger mt-1">Грешка: {{ entry.error }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            {% if entry.status == 'ok' %}
                                                <span class="badge bg-success">OK</span>
                                            {% else %}
                                                <span class="badge bg-danger">ERR</span>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="small text-muted">Няма записани логове за OCR страници.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
                    <span class="badge bg-light text-dark border">INV-{{ invoice.id }}</span>
                </div>
                <div class="text-muted small mt-1">
                    <i class="bi bi-calendar3 me-1"></i> {{ invoice.issue_date.strftime('%d.%m.%Y') if invoice.issue_date else 'Няма дата' }}
                    <span class="mx-2">•</span>
                    Качено на: {{ invoice.created_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            {% if invoice.file_path %}
                <a href="{{ url_for('static', filename=invoice.file_path) }}" target="_blank" class="btn btn-white border shadow-sm text-danger">
                    <i class="bi bi-file-pdf me-2"></i>Файл
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Error Alert -->
    {% if invoice.ocr_status == 'failed' %}
        <div class="alert alert-danger shadow-sm border-0 rounded-3 mb-4 d-flex align-items-center gap-3">
            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
            <div>
                <div class="fw-bold">Грешка при OCR обработка</div>
                <div class="small">{{ invoice.error_message or 'Системата не успя да разчете документа.' }}</div>
            </div>
        </div>
    {% endif %}

    <!-- Info Cards Row -->
    <div class="row g-4 mb-4">
        <!-- Vendor Info -->
        <div class="col-lg-4 col-md-6">
            <div class="gs-card p-4 h-100 position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                    <i class="bi bi-shop fs-1"></i>
                </div>
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.8rem; letter-spacing: 1px;">Доставчик</h6>
                
                <div class="mb-3">
                    <div class="detail-label">Име</div>
                    <div class="detail-value fs-5">{{ invoice.vendor_name or '—' }}</div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="detail-label">VAT номер</div>
                        <div class="detail-value">{{ invoice.vendor_vat_id or '—' }}</div>
                    </div>
                    <div class="col-6">
                        <div class="detail-label">IBAN</div>
                        <div class="detail-value text-truncate" title="{{ invoice.vendor_iban }}">{{ invoice.vendor_iban or '—' }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receiver Info -->
        <div class="col-lg-4 col-md-6">
            <div class="gs-card p-4 h-100 position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                    <i class="bi bi-building fs-1"></i>
                </div>
                <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.8rem; letter-spacing: 1px;">Получател</h6>
                
                <div class="mb-3">
                    <div class="detail-label">Име</div>
                    <div class="detail-value fs-5">{{ invoice.receiver_name or '—' }}</div>
                </div>
                
                <div class="mb-0">
                    <div class="detail-label">VAT номер</div>
                    <div class="detail-value">{{ invoice.receiver_vat_id or '—' }}</div>
                </div>
            </div>
        </div>

        <!-- Financials -->
        <div class="col-lg-4 col-md-12">
            <div class="gs-card p-4 h-100 bg-dark text-white" style="background: linear-gradient(145deg, #1e293b, #0f172a);">
                <h6 class="text-uppercase fw-bold mb-4 opacity-50" style="font-size: 0.8rem; letter-spacing: 1px;">Финансова справка</h6>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="opacity-75 small">Нетно</span>
                    <span class="font-monospace">{{ "%.2f"|format(invoice.net_amount or 0) }} <small>{{ invoice.currency or 'BGN' }}</small></span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom border-light border-opacity-10">
                    <span class="opacity-75 small">ДДС</span>
                    <span class="font-monospace">{{ "%.2f"|format(invoice.vat_amount or 0) }} <small>{{ invoice.currency or 'BGN' }}</small></span>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold fs-5">ОБЩО</span>
                    <span class="fw-bold fs-3 text-white" style="color: var(--gs-primary) !important;">
                        {{ "%.2f"|format(invoice.total_due or 0) }} <small class="fs-6">{{ invoice.currency or 'BGN' }}</small>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Bar / Matching Stats -->
    <div class="gs-card p-4 mb-4">
        <div class="row align-items-center gy-3">
            <div class="col-md-5">
                <div class="d-flex align-items-center gap-3">
                    <div class="position-relative d-inline-block">
                        <svg width="60" height="60" viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#eee" stroke-width="3" />
                            <path class="circle" stroke-dasharray="{{ (matched_lines / total_lines * 100) if total_lines > 0 else 0 }}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--gs-primary)" stroke-width="3" />
                        </svg>
                        <div class="position-absolute top-50 start-50 translate-middle small fw-bold">
                            {{ "%.0f"|format((matched_lines / total_lines * 100) if total_lines > 0 else 0) }}%
                        </div>
                    </div>
                    <div>
                        <div class="fw-bold text-dark">Мачнати позиции</div>
                        <div class="text-muted small">{{ matched_lines }} разпознати от общо {{ total_lines }} реда</div>
                        <div class="text-muted small mt-1">Количества: {{ matched_qty }} / {{ total_qty }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-7 text-md-end">
                {% if invoice.scan_task_id %}
                    <a href="{{ url_for('scanning.scan_task_detail', task_id=invoice.scan_task_id) }}" class="btn btn-success text-white py-2 px-4 shadow-sm fw-bold">
                        <i class="bi bi-upc-scan me-2"></i>Отвори Scan Task
                    </a>
                {% else %}
                    <form method="post" action="{{ url_for('deliveries.delivery_create_scan_task', invoice_id=invoice.id) }}" class="d-flex flex-wrap align-items-center justify-content-md-end gap-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="input-group" style="max-width: 300px;">
                            <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-house-door"></i></span>
                            <select name="warehouse_id" class="form-select border-start-0" required>
                                <option value="">Избери склад...</option>
                                {% for wh in warehouses %}
                                    <option value="{{ wh.id }}" {% if default_warehouse_id == wh.id %}selected{% endif %}>{{ wh.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button class="btn btn-dark fw-bold py-2 px-3" type="submit">
                            <i class="bi bi-box-arrow-in-down me-2"></i>Създай Scan Task
                        </button>
                    </form>
                {% endif %}
                <div class="mt-3 text-end">
                    <div class="small text-muted">Непресечени редове: <strong>{{ unmatched_count }}</strong></div>
                    {% if match_method_counts %}
                        <div class="small text-muted mt-1">Справка по метод на мачване:</div>
                        <div class="small text-muted">
                            {% for k, v in match_method_counts.items() %}
                                <span class="badge bg-light text-dark border me-1">{{ k }}: {{ v }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if top_unmatched %}
                        <div class="small text-muted mt-2">Чести непресечени: {{ top_unmatched|join(', ') }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- The Lines Table -->
    <div class="gs-card">
        <div class="p-4 border-bottom border-light d-flex justify-content-between align-items-center">
            <h5 class="fw-bold text-dark mb-0">Артикули във фактурата</h5>
            <div class="text-muted small">Всички цени са без ДДС</div>
        </div>
        <div class="table-responsive">
            <table class="table table-details mb-0">
                <thead>
                    <tr>
                        <th style="width: 10%;">Код (Vend)</th>
                        <th style="width: 25%;">Описание</th>
                        <th class="text-end" style="width: 10%;">Кол.</th>
                        <th class="text-end" style="width: 10%;">Ф-ра Цена</th>
                        <th class="text-end" style="width: 10%;">Наша Цена</th>
                        <th class="text-end" style="width: 10%;">Разлика</th>
                        <th style="width: 25%;" class="ps-4">Съответствие (ERP)</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in lines_view %}
                    {% set line = row.line %}
                    {% set product = row.product %}
                    <tr>
                        <td class="text-muted fw-semibold small">{{ line.vendor_code or '—' }}</td>
                        <td>
                            <div class="text-dark" style="line-height: 1.4; font-size: 0.9rem;">{{ line.description or '—' }}</div>
                        </td>
                        <td class="text-end">
                            <span class="badge bg-light text-dark border">{{ "%.2f"|format(line.quantity or 0) }}</span>
                            <small class="text-muted ms-1">{{ line.unit or '' }}</small>
                        </td>
                        <td class="text-end price-tag text-dark">
                            {{ "%.2f"|format(line.unit_price or 0) }}
                        </td>
                        <td class="text-end price-tag text-muted">
                            {% if row.internal_price is not none %}
                                {{ "%.2f"|format(row.internal_price) }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="text-end price-tag">
                            {% if row.diff is not none and row.diff != 0 %}
                                <span class="{{ 'diff-positive' if row.diff > 0 else 'diff-negative' }}">
                                    {{ "+" if row.diff > 0 else "" }}{{ "%.2f"|format(row.diff) }}
                                </span>
                            {% elif row.diff == 0 %}
                                <span class="diff-neutral">—</span>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="ps-4">
                            {% if product %}
                                <div class="product-match-card">
                                    <div class="d-flex align-items-center justify-content-center bg-white border rounded text-success" style="width: 32px; height: 32px; min-width: 32px;">
                                        <i class="bi bi-link-45deg fs-5"></i>
                                    </div>
                                    <div class="overflow-hidden">
                                        <div class="text-truncate fw-bold text-dark small">{{ product.name }}</div>
                                        <div class="d-flex gap-2 text-muted" style="font-size: 0.7rem;">
                                            <span><i class="bi bi-upc me-1"></i>{{ product.barcode or 'N/A' }}</span>
                                            <span>ID: {{ product.item_number }}</span>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="product-match-card opacity-50 border-dashed">
                                    <div class="d-flex align-items-center justify-content-center bg-light rounded text-muted" style="width: 32px; height: 32px; min-width: 32px;">
                                        <i class="bi bi-question-lg"></i>
                                    </div>
                                    <div class="small text-muted fst-italic">Няма намерено съвпадение</div>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            Няма редове за показване.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}