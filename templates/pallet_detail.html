{% extends "base.html" %}
{% block title %}{{ product_list.code }} | Детайли{% endblock %}

{% block content %}

<!-- 1. HEADER / COMMAND CENTER -->
<div class="card border-0 shadow-sm rounded-4 mb-4 position-relative overflow-hidden fade-in">
    <!-- GREEN STRIP ON LEFT -->
    <div class="position-absolute top-0 start-0 bottom-0" style="width: 6px; background: linear-gradient(180deg, #a6cf39 0%, #7ca323 100%);"></div>
    
    <div class="card-body p-4 ps-5">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-start gap-4">
            
            <!-- Left Side: Info -->
            <div class="flex-grow-1">
                <!-- Top Meta Row -->
                <div class="d-flex align-items-center flex-wrap gap-3 mb-2">
                    <!-- STATUS BADGE -->
                    <span class="badge rounded-pill border" style="background-color: #dcfce7; color: #166534; border-color: #bbf7d0 !important; padding: 6px 12px;">
                        <i class="bi bi-circle-fill me-1" style="font-size: 6px; vertical-align: middle; color: #16a34a;"></i>
                        АКТИВЕН
                    </span>

                    <!-- PALLETIZED STATUS -->
                    {% if product_list.is_pallet %}
                        <span class="badge bg-dark text-white border font-monospace">
                            <i class="bi bi-box-seam-fill me-1 text-success"></i> {{ product_list.pallet_code }}
                        </span>
                    {% else %}
                        <span class="badge bg-light text-muted border">
                            <i class="bi bi-dash-circle me-1"></i> НЕ Е ПАЛЕТИЗИРАН
                        </span>
                    {% endif %}

                    <span class="text-muted small ms-1">
                        <i class="bi bi-clock me-1"></i> {{ product_list.updated_at.strftime('%d.%m.%Y %H:%M') }}
                    </span>
                </div>

                <!-- Title -->
                <h1 class="fw-bold text-dark mb-4">{{ product_list.title }}</h1>

                <!-- Location Box -->
                <div class="d-flex align-items-center p-3 rounded-3 gap-5" style="background-color: #f8fafc; border: 1px solid #f1f5f9; max-width: 500px;">
                    <!-- Warehouse -->
                    <div class="d-flex align-items-center gap-3">
                        <div class="rounded-3 bg-white border d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-building-fill text-secondary"></i>
                        </div>
                        <div>
                            <div class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px;">Склад</div>
                            <div class="fw-bold text-dark">{{ product_list.current_warehouse.name }}</div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div style="width: 1px; height: 30px; background: #e2e8f0;"></div>

                    <!-- Location -->
                    <div class="d-flex align-items-center gap-3">
                         <div class="rounded-3 bg-white border d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi bi-geo-alt-fill text-danger"></i>
                        </div>
                        <div>
                            <div class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px;">Локация</div>
                            <div class="fw-bold text-dark">
                                {{ product_list.storage_location or 'Няма' }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Buttons -->
            <div class="d-flex align-items-center gap-2">
                <a href="{{ url_for('logistics.simple_list_index') }}" class="btn btn-white border shadow-sm d-flex align-items-center justify-content-center" style="height: 46px; width: 46px;" title="Назад">
                    <i class="bi bi-arrow-left text-dark"></i>
                </a>

                <a href="{{ url_for('logistics.pallet_label', list_id=product_list.id) }}" target="_blank" class="btn btn-white border shadow-sm d-flex align-items-center justify-content-center" style="height: 46px; width: 46px;" title="Принтирай Етикет">
                    <i class="bi bi-printer-fill text-dark"></i>
                </a>

                <a href="{{ url_for('logistics.edit_list', list_id=product_list.id) }}" class="btn-brand-new text-white text-decoration-none d-flex align-items-center gap-2 shadow-sm px-4" style="height: 46px;">
                    <i class="bi bi-qr-code-scan"></i>
                    <span>Редакция</span>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <div class="d-flex flex-column flex-md-row flex-wrap gap-3 align-items-end">
                <div class="flex-grow-1">
                    <label class="form-label small text-uppercase text-muted mb-1">Принтер за палет</label>
                    <select class="form-select form-select-sm" id="list-printer-select">
                        <option value="">Избери принтер от списъка</option>
                        {% for printer in list_printers %}
                        <option value="{{ printer.id }}" {% if printer.id == list_default_printer_id %}selected{% endif %}>
                            {{ printer.name or printer.ip_address }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            <div style="min-width: 110px;">
                <label class="form-label small text-uppercase text-muted mb-1">Бройки</label>
                <input id="list-print-copies" type="number" min="1" class="form-control form-control-sm" value="1">
            </div>
                <div>
                    <button id="list-print-btn" class="btn btn-brand-new">Принтирай етикет</button>
                </div>
        </div>
        <div class="small text-muted mt-2" id="list-print-status"></div>
    </div>
</div>

<!-- 2. METRICS & QR GRID (UPDATED WITH WEIGHT/VOLUME) -->
<div class="row g-4 mb-4 fade-in" style="animation-delay: 0.1s;">
    <!-- 1. QR Code -->
    <div class="col-md-4 col-lg-3">
        <div class="card h-100 border-0 shadow-sm rounded-4">
            <div class="card-body d-flex flex-column align-items-center justify-content-center p-4" 
                 style="border: 2px dashed #cbd5e1; border-radius: 16px; margin: 8px;">
                <img src="{{ url_for('logistics.pallet_qr', list_id=product_list.id) }}" alt="QR" class="img-fluid mb-2" style="max-height: 100px; mix-blend-mode: multiply;">
                <div class="small fw-bold text-muted font-monospace">{{ product_list.code }}</div>
            </div>
        </div>
    </div>

    <!-- 2. Items Type -->
    <div class="col-md-4 col-lg-3">
        <div class="card h-100 border-0 shadow-sm rounded-4">
            <div class="card-body p-4 d-flex flex-column justify-content-center">
                <div class="mb-3">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                        <i class="bi bi-list-ul text-primary fs-4"></i>
                    </div>
                </div>
                <div class="text-uppercase text-muted fw-bold small mb-1">Артикули</div>
                <div class="d-flex align-items-baseline gap-1">
                    <span class="fw-bold text-dark" style="font-size: 2rem;">{{ totals.line_count }}</span>
                    <span class="text-muted fw-bold">вида</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Total Quantity -->
    <div class="col-md-4 col-lg-3">
         <div class="card h-100 border-0 shadow-sm rounded-4">
            <div class="card-body p-4 d-flex flex-column justify-content-center">
                <div class="mb-3">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                        <i class="bi bi-box-seam-fill text-success fs-4"></i>
                    </div>
                </div>
                <div class="text-uppercase text-muted fw-bold small mb-1">Общо Брой</div>
                <div class="d-flex align-items-baseline gap-1">
                    <span class="fw-bold text-dark" style="font-size: 2rem;">{{ "%.0f"|format(totals.total_pieces) }}</span>
                    <span class="text-muted fw-bold">бр.</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. NEW: Weight & Volume -->
    <div class="col-md-4 col-lg-3">
         <div class="card h-100 border-0 shadow-sm rounded-4">
            <div class="card-body p-4 d-flex flex-column justify-content-center">
                <div class="mb-3">
                    <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                        <i class="bi bi-speedometer2 text-warning fs-4"></i>
                    </div>
                </div>
                <div class="text-uppercase text-muted fw-bold small mb-1">Тегло / Обем</div>
                <div class="d-flex align-items-baseline gap-1">
                    <span class="fw-bold text-dark" style="font-size: 1.8rem;">{{ "%.2f"|format(totals.total_weight) }}</span>
                    <span class="text-muted fw-bold">kg</span>
                </div>
                <div class="text-muted small mt-1 fw-bold">
                    <i class="bi bi-box me-1"></i>{{ "%.3f"|format(totals.total_volume) }} m³
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3. CONTENT SPLIT -->
<div class="row g-4 fade-in" style="animation-delay: 0.2s;">
    
    <!-- LEFT: Content Table -->
    <div class="col-lg-8">
        <h5 class="fw-bold text-dark mb-3">Съдържание на списъка</h5>
        
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 text-muted small text-uppercase py-3" style="width: 50px;">#</th>
                            <th class="text-muted small text-uppercase py-3">Продукт</th>
                            <th class="text-end pe-4 text-muted small text-uppercase py-3">Количество</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in product_list.items %}
                        <tr class="cursor-pointer" onclick="window.location='{{ url_for('products.product_detail', product_id=item.product.id) }}'">
                            <td class="ps-4 fw-bold text-muted">{{ loop.index }}</td>
                            <td class="py-3">
                                <div class="d-flex align-items-center gap-3">
                                    <!-- THUMBNAIL -->
                                    <div class="rounded-3 border d-flex align-items-center justify-content-center bg-white p-1" style="width: 48px; height: 48px;">
                                        {% set img_src = item.product.image_url or '' %}
                                        {% if img_src %}
                                            {% if not img_src.startswith('http') %}{% set img_src = url_for('static', filename=img_src.lstrip('/')) %}{% endif %}
                                            <img src="{{ img_src }}" alt="Img" class="w-100 h-100 object-fit-contain">
                                        {% else %}
                                            <i class="bi bi-image text-muted opacity-25"></i>
                                        {% endif %}
                                    </div>
                                    
                                    <div>
                                        <div class="fw-bold text-dark">{{ item.product.name }}</div>
                                        <div class="d-flex gap-2 small">
                                            <span class="badge bg-light text-muted border fw-normal">{{ item.product.item_number }}</span>
                                            {% if item.product.brand %}
                                                <span class="text-muted border-start ps-2">{{ item.product.brand }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end pe-4">
                                <div class="d-inline-block bg-light rounded-3 px-3 py-1">
                                    <span class="fw-bold text-dark fs-5">{{ "%.0f"|format(item.quantity) }}</span>
                                    <span class="small text-muted fw-bold text-uppercase ms-1">{{ item.unit }}</span>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center py-5 text-muted">
                                <div class="opacity-50 mb-2"><i class="bi bi-basket3 fs-1"></i></div>
                                Списъкът е празен.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- RIGHT: Details / History -->
    <div class="col-lg-4">
        <h5 class="fw-bold text-dark mb-3">Детайли</h5>
        
        <!-- CREATOR CARD -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="bi bi-person-fill text-secondary fs-4"></i>
                    </div>
                    <div>
                        <div class="text-uppercase text-muted fw-bold small">Създател</div>
                        <div class="fw-bold text-dark">{{ product_list.created_by.full_name if product_list.created_by else 'Система' }}</div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <div class="text-uppercase text-muted fw-bold small mb-1">Създаден</div>
                        <div class="fw-bold text-dark font-monospace">{{ product_list.created_at.strftime('%d.%m %H:%M') }}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-uppercase text-muted fw-bold small mb-1">Обновен</div>
                        <div class="fw-bold text-dark font-monospace">{{ product_list.updated_at.strftime('%d.%m %H:%M') }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATUS CARD -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
             <div class="card-body p-3">
                <h6 class="fw-bold text-dark small text-uppercase mb-3">Статус на палетизация</h6>
                
                {% if product_list.is_pallet %}
                    <div class="alert alert-success d-flex align-items-center gap-3 mb-0 border-0 bg-success bg-opacity-10">
                        <i class="bi bi-check-circle-fill text-success fs-4"></i>
                        <div>
                            <div class="fw-bold text-success">Палетизиран</div>
                            <div class="small text-muted font-monospace">{{ product_list.pallet_code }}</div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-secondary d-flex align-items-center gap-3 mb-3 border-0 bg-secondary bg-opacity-10">
                        <i class="bi bi-box-seam text-secondary fs-4"></i>
                        <div>
                            <div class="fw-bold text-dark">Свободен списък</div>
                            <div class="small text-muted">Все още не е палетизиран.</div>
                        </div>
                    </div>
                    
                    <form action="{{ url_for('logistics.palletize_list', list_id=product_list.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-dark w-100 py-2 rounded-3">
                            <i class="bi bi-box-seam-fill me-2"></i> Палетизирай сега
                        </button>
                    </form>
                {% endif %}
             </div>
        </div>

        <!-- INFO CARD -->
        <div class="alert alert-light border shadow-sm rounded-4 d-flex gap-3 align-items-start">
            <i class="bi bi-info-circle-fill text-primary mt-1"></i>
            <div class="small text-muted" style="line-height: 1.5;">
                Този списък е <strong>"Лайт"</strong>. Използва се за бързи справки и инвентаризация в реално време.
            </div>
        </div>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; transition: background-color 0.2s; }
    .cursor-pointer:hover { background-color: #f8fafc; }
    
    .btn-white {
        background: #fff; color: #334155;
        transition: all 0.2s;
    }
    .btn-white:hover {
        background: #f1f5f9; border-color: #cbd5e1;
    }
    
    .btn-brand-new {
        background: linear-gradient(135deg, #a6cf39 0%, #7ca323 100%);
        border: none;
        box-shadow: 0 4px 12px rgba(166, 207, 57, 0.3);
    }
    .btn-brand-new:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(166, 207, 57, 0.4);
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const printBtn = document.getElementById("list-print-btn");
        const printerSelect = document.getElementById("list-printer-select");
        const copiesInput = document.getElementById("list-print-copies");
        const statusEl = document.getElementById("list-print-status");
        const defaultPrinterId = {{ list_default_printer_id if list_default_printer_id else "null" }};
        const listId = {{ product_list.id }};
        const listName = "{{ (product_list.title or product_list.code)|e }}";
        const listCode = "{{ product_list.pallet_code or product_list.code|e }}";

        function setStatus(message, isSuccess) {
            if (!statusEl) {
                return;
            }
            statusEl.textContent = message;
            statusEl.classList.toggle("text-success", Boolean(isSuccess));
            statusEl.classList.toggle("text-danger", Boolean(isSuccess) === false);
        }

        if (!printBtn) {
            return;
        }

        printBtn.addEventListener("click", function () {
            const selected = printerSelect?.value;
            const printerId = selected ? parseInt(selected, 10) : defaultPrinterId;
            if (!printerId) {
                setStatus("Изберете принтер.", false);
                return;
            }
            let copies = parseInt(copiesInput?.value, 10);
            if (isNaN(copies) || copies < 1) {
                copies = 1;
            }
            printBtn.disabled = true;
            setStatus("Изпращам етикета...", true);
            fetch("/printer-hub/print-list", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    printer_id: printerId,
                    copies: copies,
                    name: listName,
                    qr_data: listCode,
                }),
            })
                .then(async (response) => {
                    const contentType = response.headers.get("content-type") || "";
                    let data;
                    if (contentType.includes("application/json")) {
                        data = await response.json();
                    } else {
                        data = { message: await response.text() };
                    }
                    return { ok: response.ok, data };
                })
                .then(({ ok, data }) => {
                    if (!ok) {
                        throw new Error(data.message || "Грешка при отпечатване.");
                    }
                    setStatus(data.message || "Етикетът е изпратен.", true);
                })
                .catch((err) => {
                    console.error(err);
                    setStatus(err.message || "Грешка при изпращане към принтера.", false);
                })
                .finally(() => {
                    printBtn.disabled = false;
                });
        });
    });
</script>

{% endblock %}
