{% extends "base.html" %}
{% block title %}Каталог | GSTROY{% endblock %}

{% block content %}
<style>
    .search-suggest-wrapper { position: relative; }
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 6px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        max-height: 260px;
        overflow-y: auto;
        z-index: 1000;
    }
    .search-suggestion-item {
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: 0;
        background: transparent;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .search-suggestion-item:hover { background: #f8fafc; }
    .search-suggestion-title { font-weight: 600; color: #0f172a; font-size: 0.9rem; }
    .search-suggestion-meta { font-size: 0.75rem; color: #64748b; }
    .search-suggestion-empty { padding: 8px 12px; font-size: 0.8rem; color: #94a3b8; }
</style>

<!-- MOBILE FILTER BUTTON -->
<div class="d-lg-none position-fixed start-50 translate-middle-x z-3" style="bottom: 100px;">
    <button class="btn btn-brand-new shadow-lg px-4 py-2 rounded-pill d-flex align-items-center gap-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterCanvas">
        <i class="bi bi-sliders"></i> Филтри
    </button>
</div>

<div class="row g-4">
    <!-- SIDEBAR FILTERS (DESKTOP) -->
    <div class="col-lg-3 d-none d-lg-block">
        <aside class="filter-panel custom-scrollbar">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h5 class="fw-bold m-0"><i class="bi bi-sliders2 me-2 text-success"></i>Филтри</h5>
                <a href="{{ url_for('products.products') }}" class="text-muted small text-decoration-none hover-underline">Изчисти</a>
            </div>
            
            <form>
                <div class="mb-4">
                    <div class="filter-heading">Ключова дума</div>
                    <div class="input-group-aero search-suggest-wrapper">
                        <input type="text" class="input-aero ps-5" id="product-search-input" name="name" value="{{ name_query }}" placeholder="Търси..." autocomplete="off" data-suggest-url="{{ url_for('products.product_suggest') }}">
                        <i class="bi bi-search input-icon"></i>
                        <div id="product-search-suggestions" class="search-suggestions d-none"></div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="filter-heading">Производител</div>
                    <div class="input-group-aero">
                        <select class="input-aero select-aero" name="brand">
                            <option value="">Всички марки</option>
                            {% for brand in brands %}
                                <option value="{{ brand }}" {% if selected_brand == brand %}selected{% endif %}>{{ brand }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="filter-heading mb-3">Категории</div>
                    <div class="d-flex flex-column category-container ps-1">
                        {% for node in category_tree %}
                            <div class="tree-item">
                                <div class="tree-trigger d-flex align-items-center justify-content-between">
                                    <a href="{{ url_for('products.category_page', slug=node.slug) }}" class="text-decoration-none text-reset">{{ node.name }}</a>
                                    {% if node.children %}
                                        <button class="btn btn-sm p-0 border-0 text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#tree-{{ loop.index }}" aria-expanded="false">
                                            <i class="bi bi-chevron-down tree-icon"></i>
                                        </button>
                                    {% endif %}
                                </div>
                                {% if node.children %}
                                <div class="collapse" id="tree-{{ loop.index }}">
                                    <div class="tree-submenu">
                                        {% for child in node.children %}
                                            <a href="{{ url_for('products.category_page', slug=child.slug) }}" class="sub-link">{{ child.name }}</a>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <input type="hidden" name="view" value="{{ view_mode }}">
                <button class="btn-filter-apply w-100 mt-2">ПРИЛОЖИ</button>
            </form>
        </aside>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="col-lg-9">
        
        <!-- Top Toolbar -->
        <div class="catalog-toolbar fade-in">
            <div class="me-auto">
                <h1 class="h4 fw-bold text-dark mb-0">Продукти</h1>
                <span class="text-muted small" id="total-count-label">{{ total_items }} резултата</span>
            </div>
            
            <div class="bg-light p-1 rounded-3 d-flex border">
                <a href="{{ cards_url }}" class="btn btn-sm border-0 rounded-2 {{ 'bg-white shadow-sm fw-bold text-dark' if view_mode == 'cards' else 'text-muted' }}">
                    <i class="bi bi-grid-fill"></i>
                </a>
                <a href="{{ table_url }}" class="btn btn-sm border-0 rounded-2 {{ 'bg-white shadow-sm fw-bold text-dark' if view_mode == 'table' else 'text-muted' }}">
                    <i class="bi bi-list-ul"></i>
                </a>
            </div>
        </div>

        <!-- PRODUCTS GRID / TABLE WRAPPER -->
        <!-- Тук зареждаме първите 30 продукта -->
        <div id="products-wrapper">
            {% if view_mode == 'cards' %}
                <div id="products-container" class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4">
                    {% include "products_partial.html" %}
                </div>
            {% else %}
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden fade-in">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 table-clean">
                            <thead>
                                <tr>
                                    <th class="ps-4">Артикул</th>
                                    <th>Наименование</th>
                                    <th>Марка</th>
                                    <th>Локация</th>
                                    <th class="text-end pe-4">Цена</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                {% include "products_partial.html" %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- LOAD MORE BUTTON -->
        {% if has_more %}
        <div class="text-center mt-5 mb-5" id="load-more-section">
            <p class="text-muted small mb-3" id="shown-count-label">Показани са {{ products|length }} от {{ total_items }}</p>
            <button id="btn-load-more" class="btn-load-more" data-next-page="{{ next_page }}">
                <span class="spinner-border spinner-border-sm d-none me-2"></span>
                <span class="btn-text">Покажи още</span> <i class="bi bi-chevron-down ms-1"></i>
            </button>
        </div>
        {% endif %}

    </div>
</div>

<!-- OFFCANVAS FILTERS (MOBILE) -->
<div class="offcanvas offcanvas-bottom offcanvas-bottom-rounded" tabindex="-1" id="filterCanvas">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-bold">Филтри</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body p-4">
    <form>
        <div class="mb-3">
            <label class="form-label small fw-bold text-muted">Търсене</label>
            <input type="text" class="form-control form-control-lg bg-light border-0" name="name" value="{{ name_query }}">
        </div>
        <!-- Add other mobile filters here if needed -->
        <input type="hidden" name="view" value="{{ view_mode }}">
        <button class="btn btn-brand-new w-100 py-3 mt-4">Приложи</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('btn-load-more');
    if (!btn) return;

    btn.addEventListener('click', function() {
        const nextPage = btn.getAttribute('data-next-page');
        const spinner = btn.querySelector('.spinner-border');
        const btnText = btn.querySelector('.btn-text');
        const icon = btn.querySelector('.bi');
        const container = document.getElementById('products-container'); // For cards
        const tableBody = document.getElementById('products-table-body'); // For table

        // UI Loading
        btn.disabled = true;
        spinner.classList.remove('d-none');
        icon.classList.add('d-none');
        btnText.textContent = 'Зареждане...';

        // Build URL
        const url = new URL(window.location.href);
        url.searchParams.set('page', nextPage);
        url.searchParams.set('partial', '1'); // Tell backend we want only HTML

        fetch(url)
            .then(res => res.text())
            .then(html => {
                if (!html.trim()) {
                    document.getElementById('load-more-section').remove();
                    return;
                }

                // Append Content
                if (container) {
                    container.insertAdjacentHTML('beforeend', html);
                } else if (tableBody) {
                    tableBody.insertAdjacentHTML('beforeend', html);
                }

                // Update State
                const newPage = parseInt(nextPage) + 1;
                btn.setAttribute('data-next-page', newPage);
                
                // Update Counts
                const currentItems = document.querySelectorAll('.fade-in-item').length;
                const totalItems = "{{ total_items }}";
                document.getElementById('shown-count-label').textContent = `Показани са ${currentItems} от ${totalItems}`;

                if (currentItems >= parseInt(totalItems)) {
                    document.getElementById('load-more-section').remove();
                } else {
                    btn.disabled = false;
                    spinner.classList.add('d-none');
                    icon.classList.remove('d-none');
                    btnText.textContent = 'Покажи още';
                }
            })
            .catch(err => {
                console.error(err);
                btnText.textContent = 'Грешка';
            });
    });

    const searchInput = document.getElementById('product-search-input');
    const suggestions = document.getElementById('product-search-suggestions');
    if (searchInput && suggestions) {
        const suggestUrl = searchInput.dataset.suggestUrl;
        let timer = null;

        const hideSuggestions = () => {
            suggestions.classList.add('d-none');
            suggestions.innerHTML = '';
        };

        const renderSuggestions = (items) => {
            if (!items.length) {
                suggestions.innerHTML = '<div class="search-suggestion-empty">Няма резултати</div>';
                suggestions.classList.remove('d-none');
                return;
            }
            suggestions.innerHTML = items.map((item) => {
                const code = item.item_number || '';
                const name = item.name || code;
                const meta = [item.brand, item.category].filter(Boolean).join(' • ');
                const metaLine = meta ? `${code} • ${meta}` : code;
                return `
                    <button type="button" class="search-suggestion-item" data-value="${code}">
                        <span class="search-suggestion-title">${name}</span>
                        <span class="search-suggestion-meta">${metaLine}</span>
                    </button>
                `;
            }).join('');
            suggestions.classList.remove('d-none');
        };

        const fetchSuggestions = (value) => {
            fetch(`${suggestUrl}?q=${encodeURIComponent(value)}`)
                .then((res) => res.json())
                .then((data) => renderSuggestions(data.items || []))
                .catch(() => hideSuggestions());
        };

        searchInput.addEventListener('input', () => {
            const value = searchInput.value.trim();
            if (value.length < 2) {
                hideSuggestions();
                return;
            }
            clearTimeout(timer);
            timer = setTimeout(() => fetchSuggestions(value), 250);
        });

        suggestions.addEventListener('click', (event) => {
            const btn = event.target.closest('.search-suggestion-item');
            if (!btn) {
                return;
            }
            searchInput.value = btn.dataset.value || searchInput.value;
            const form = searchInput.closest('form');
            if (form) {
                form.submit();
            }
            hideSuggestions();
        });

        document.addEventListener('click', (event) => {
            if (event.target === searchInput || suggestions.contains(event.target)) {
                return;
            }
            hideSuggestions();
        });
    }
});
</script>
{% endblock %}
