{% extends "base.html" %}
{% block title %}Лайт Списъци | GSTROY{% endblock %}

{% block content %}

<!-- HEADER AREA -->
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-end gap-3 mb-4 fade-in">
  <div>
    <h1 class="h3 fw-bold text-dark mb-1">Лайт Списъци</h1>
    <p class="text-muted mb-0">Бързи инвентарни списъци и проверки в реално време.</p>
  </div>
  
  <div class="d-flex flex-wrap align-items-center gap-2">
    <!-- View Toggle -->
    <div class="bg-white p-1 rounded-3 d-flex border me-2 shadow-sm">
        <a href="{{ cards_url }}" class="btn btn-sm border-0 rounded-2 {{ 'bg-dark text-white shadow-sm' if view_mode == 'cards' else 'text-muted' }}">
            <i class="bi bi-grid-fill"></i>
        </a>
        <a href="{{ table_url }}" class="btn btn-sm border-0 rounded-2 {{ 'bg-dark text-white shadow-sm' if view_mode == 'table' else 'text-muted' }}">
            <i class="bi bi-list-ul"></i>
        </a>
    </div>

    <!-- Add Button (Neon Green) -->
    <a href="{{ url_for('logistics.simple_list_new') }}" class="btn-brand-new d-flex align-items-center gap-2 text-white text-decoration-none">
      <i class="bi bi-plus-lg"></i>
      <span>Нов списък</span>
    </a>
  </div>
</div>

<!-- SEARCH AREA -->
<div class="mb-4 fade-in" style="animation-delay: 0.1s;">
  <label class="form-label fw-semibold text-muted small text-uppercase ms-1">Бързо търсене</label>
  <div class="search-wrapper">
    <input type="text" class="search-input-hero" id="listSearchDisplay" placeholder="Сканирай или търси по име..." autocomplete="off">
    <!-- Colored Icon -->
    <i class="bi bi-search search-icon-fixed" style="color: var(--brand-green);"></i>
  </div>
  <div class="d-flex justify-content-between mt-2 px-1">
    <small class="text-muted fst-italic"><i class="bi bi-lightning-charge-fill text-warning"></i> Бърз достъп</small>
    <button class="btn btn-link btn-sm text-muted text-decoration-none p-0" type="button" id="listSearchClear">Изчисти</button>
  </div>
</div>
<input type="text" id="listSearchHidden" class="visually-hidden" autocomplete="off">

<!-- CONTENT GRID / TABLE -->
<div class="fade-in" style="animation-delay: 0.2s;">
{% if not product_lists %}
  <!-- Empty State -->
  <div class="text-center py-5 border border-2 border-dashed rounded-4 bg-white">
    <div class="mb-3">
        <span class="d-inline-block p-3 rounded-circle bg-light text-muted">
            <i class="bi bi-clipboard-x fs-1"></i>
        </span>
    </div>
    <h5 class="mt-3 text-muted fw-normal">Няма активни списъци</h5>
    <p class="small mb-4 text-muted">Започнете с бутона за нов списък.</p>
    <a href="{{ url_for('logistics.simple_list_new') }}" class="btn-brand-new text-white text-decoration-none px-4">Създай първи списък</a>
  </div>
{% else %}

  {% if view_mode == 'cards' %}
      <!-- GRID VIEW -->
      <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
        {% for product_list in product_lists %}
          {% set totals = totals_by_list[product_list.id] %}
          <div class="col" data-search-value="{{ (product_list.code ~ ' ' ~ product_list.title ~ ' ' ~ product_list.current_warehouse.name ~ ' ' ~ (product_list.storage_location or '')) | lower }}">
            
            <div class="modern-card h-100">
              <!-- Header -->
              <div class="card-header-strip pb-0 border-0 bg-transparent pt-3 px-3">
                 <div class="d-flex justify-content-between align-items-center w-100">
                     <!-- Icon & Code -->
                     <div class="d-flex align-items-center gap-2">
                         <!-- Тъмно зелена икона за списък -->
                         <i class="bi bi-clipboard-data-fill" style="color: var(--brand-green-dark); font-size: 1.2rem;"></i>
                         <span class="fw-bold text-dark font-monospace" style="font-size: 0.95rem;">{{ product_list.code }}</span>
                     </div>
                     <!-- Date Badge -->
                     <span class="badge rounded-pill bg-light text-secondary border px-3 py-2">
                         {{ product_list.created_at.strftime('%d.%m') }} <span class="opacity-25 mx-1">|</span> {{ product_list.created_at.strftime('%H:%M') }}
                     </span>
                 </div>
              </div>

              <!-- Body -->
              <div class="card-body-custom pt-2">
                <!-- Title -->
                <h5 class="fw-bold text-dark mb-3 mt-1 text-truncate" style="font-size: 1.1rem;" title="{{ product_list.title }}">
                    {{ product_list.title }}
                </h5>
                
                <!-- Location Box (Grey Background) -->
                <div class="location-visual mb-3" style="background-color: #f8fafc; border-radius: 8px; padding: 10px;">
                    <div class="d-flex align-items-center gap-2" style="font-size: 0.95rem;">
                        <i class="bi bi-building-fill text-secondary"></i>
                        <span class="fw-bold text-dark text-truncate">{{ product_list.current_warehouse.name }}</span>
                        
                        {% if product_list.storage_location %}
                            <span class="text-muted mx-1 opacity-25">|</span>
                            <i class="bi bi-geo-alt-fill text-danger opacity-75"></i>
                            <span class="fw-bold text-secondary">{{ product_list.storage_location }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Creator Row -->
                <div class="d-flex align-items-center gap-2 text-muted small mb-3 ps-1">
                    <i class="bi bi-person-circle text-secondary opacity-50"></i>
                    <span class="fw-500">{{ product_list.created_by.full_name if product_list.created_by else 'Система' }}</span>
                </div>

                <!-- STATS GRID -->
                <div class="stats-grid mb-3">
                    <div class="stat-box">
                        <div class="stat-label">Редове</div>
                        <div class="stat-val text-dark">{{ totals.line_count }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Общ Брой</div>
                        <div class="stat-val text-dark">{{ "%.0f"|format(totals.total_quantity) }}</div>
                    </div>
                </div>
                
                <!-- FOOTER ACTIONS (THE BIG BUTTONS) -->
                <div class="mt-auto pt-2 d-flex gap-2">
                    <!-- White Button -->
                    <a href="{{ url_for('logistics.simple_list_detail', list_id=product_list.id) }}" class="btn btn-light border fw-bold flex-grow-1" style="color: #64748b; border-color: #e2e8f0;">
                        Преглед
                    </a>
                    <!-- Green Neon Button -->
                    <a href="{{ url_for('logistics.simple_list_edit', list_id=product_list.id) }}" class="btn-brand-new flex-grow-1 text-center text-decoration-none d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-qr-code-scan"></i>
                        РЕДАКЦИЯ
                    </a>
                </div>
              </div>
            </div>

          </div>
        {% endfor %}
      </div>

  {% else %}
      <!-- TABLE VIEW -->
      <div class="modern-card p-0">
        <div class="table-responsive">
            <table class="table table-modern mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">Код</th>
                        <th>Наименование</th>
                        <th>Склад / Локация</th>
                        <th>Създател</th>
                        <th class="text-center">Общо</th>
                        <th class="text-end pe-4">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product_list in product_lists %}
                    {% set totals = totals_by_list[product_list.id] %}
                    <tr data-search-value="{{ (product_list.code ~ ' ' ~ product_list.title) | lower }}" class="table-row-link" onclick="window.location='{{ url_for('logistics.simple_list_detail', list_id=product_list.id) }}'">
                        <td class="ps-4">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-clipboard-data text-success"></i>
                                <span class="fw-bold font-monospace text-dark">{{ product_list.code }}</span>
                            </div>
                            <div class="small text-muted ps-4 ms-1">{{ product_list.created_at.strftime('%d.%m %H:%M') }}</div>
                        </td>
                        <td>
                            <span class="fw-bold text-dark prod-name">{{ product_list.title }}</span>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-semibold text-dark">{{ product_list.current_warehouse.name }}</span>
                                {% if product_list.storage_location %}
                                    <span class="small text-muted"><i class="bi bi-geo-alt-fill text-danger me-1"></i>{{ product_list.storage_location }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-secondary border fw-normal">
                                <i class="bi bi-person me-1"></i> {{ product_list.created_by.username if product_list.created_by else 'System' }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="qty-pill">
                                {{ "%.0f"|format(totals.total_quantity) }}
                            </div>
                        </td>
                        <td class="text-end pe-4" onclick="event.stopPropagation()">
                            <a href="{{ url_for('logistics.simple_list_edit', list_id=product_list.id) }}" class="btn btn-sm btn-brand-new text-white rounded-3 px-3">
                                <i class="bi bi-qr-code me-1"></i> Скен
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
      </div>
  {% endif %}

{% endif %}
</div>

<script>
    // Filter Script
    (function () {
      const display = document.getElementById('listSearchDisplay');
      const hidden = document.getElementById('listSearchHidden');
      const clearBtn = document.getElementById('listSearchClear');
      const items = document.querySelectorAll('[data-search-value]');

      function applyFilter(value) {
        const needle = (value || '').trim().toLowerCase();
        items.forEach(function (item) {
          const hay = item.getAttribute('data-search-value') || '';
          if (!needle || hay.includes(needle)) {
             item.style.display = item.tagName === 'TR' ? 'table-row' : '';
          } else {
             item.style.display = 'none';
          }
        });
      }

      if (display) {
        display.addEventListener('input', function (event) { applyFilter(event.target.value); });
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', function () {
          display.value = ''; hidden.value = ''; applyFilter(''); hidden.focus();
        });
      }
      if (hidden) {
        hidden.addEventListener('keydown', function (event) {
          if (event.key === 'Enter') {
            display.value = hidden.value; applyFilter(hidden.value); hidden.value = ''; event.preventDefault();
          }
        });
      }
      document.addEventListener('keydown', function (event) {
        const target = event.target;
        if (target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA')) return;
        if (event.key.length === 1 || event.key === 'Enter') hidden.focus();
      });
      hidden.focus();
    })();
</script>
{% endblock %}
